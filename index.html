<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta P√∫blica de Recibos</title>
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; padding: 16px; background: #f5f6fa; color: #0f172a; }
    h1 { margin: 0 0 12px; font-size: 22px; text-align: center; }
    h2 { margin: 12px 0 8px; font-size: 18px; }
    .layout { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 2px 10px rgba(15,23,42,0.06); padding: 20px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: stretch; }
    input { flex: 1; min-width: 0; padding: 12px 14px; border: 1px solid #cfd4dc; border-radius: 8px; font-size: 16px; width: 100%; }
    button { background: linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; border: none; border-radius: 8px; padding: 12px 20px; font-weight: 600; cursor: pointer; font-size: 15px; white-space: nowrap; }
    button:hover { filter: brightness(1.05); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .muted { color: #6b7280; font-size: 14px; }
    .status { margin-top: 10px; padding: 10px; border-radius: 8px; background: #f1f5f9; border: 1px solid #e2e8f0; }
    .recibo-wrapper { margin-top: 12px; }
    
    /* Estilos del recibo */
    .recibo-imprimible {
      max-width: 500px;
      margin: 0 auto;
      font-family: Arial, sans-serif;
      color: #222831 !important;
      font-size: 0.85rem;
      background-color: white !important;
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
    }

    .recibo-principal {
      padding-bottom: 10px;
      margin-bottom: 10px;
    }

    .recibo-header {
      padding-bottom: 10px;
      border-bottom: 2px solid #2c5282;
      margin-bottom: 12px;
    }

    .header-linea-1 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .empresa-titulo {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .icono-empresa {
      font-size: 1.2rem;
      color: #2c5282;
    }

    .nombre-empresa {
      font-size: 1rem;
      font-weight: 700;
      color: #2c5282;
      letter-spacing: 0.5px;
    }

    .numero-recibo-principal {
      font-size: 1rem;
      font-weight: bold;
      color: #2c5282;
      padding: 4px 8px;
      background-color: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
    }

    .header-linea-2 {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tipo-documento {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c5282;
      letter-spacing: 1px;
    }

    .fecha-periodo {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    .fecha-periodo span {
      font-size: 0.8rem;
      color: #4a5568;
    }

    .recibo-cliente-datos-completos {
      padding: 8px 10px;
    }

    .fila-datos {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 6px;
    }

    .recibo-cliente {
      margin-bottom: 10px;
    }

    .recibo-cliente h3 {
      background-color: #2c5282;
      color: white;
      padding: 4px 8px;
      font-size: 0.9rem;
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 6px;
    }

    .recibo-cliente-datos {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 3px 8px;
      padding: 0 5px;
    }

    .campo-recibo {
      margin-bottom: 0;
      font-size: 0.85rem;
    }

    .campo-recibo strong {
      font-weight: 700;
    }

    .hola {
      margin-left: 50px;
    }

    .recibo-consumo h3 {
      background-color: #2c5282;
      color: white;
      padding: 4px 8px;
      font-size: 0.9rem;
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 6px;
    }

    .tabla-consumo {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 0.75rem;
    }

    .tabla-consumo th, .tabla-consumo td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
      color: #222831 !important;
      background-color: white !important;
    }

    .tabla-consumo th {
      background-color: #f0f4f8;
      font-weight: 700;
    }

    .deuda-otros-row {
      background-color: #fef7e7 !important;
    }

    .deuda-lectura-row {
      background-color: #f0f9ff !important;
    }

    .deuda-otros-row td, 
    .deuda-lectura-row td {
      font-style: italic;
      color: #1f2937 !important;
    }

    .monto-pagar {
      font-weight: bold;
    }

    .recibo-total {
      text-align: center;
      margin-top: 12px;
      margin-bottom: 12px;
    }

    .recibo-total h3 {
      font-size: 1.1rem;
      color: #222831;
      font-weight: 700;
      margin: 0;
    }

    .recibo-nota {
      margin-top: 10px;
      font-size: 0.8rem;
      padding-top: 8px;
      border-top: 1px dashed #ccc;
    }

    .recibo-comprobante {
      border-top: 1px dashed #aaa;
      margin-top: 15px;
      padding-top: 10px;
    }

    .comprobante-header {
      background-color: #edf2f7;
      padding: 8px;
      margin-bottom: 12px;
      text-align: center;
      color: #222831;
    }

    .comprobante-header h3 {
      font-size: 0.95rem !important;
      text-align: center;
      margin: 0 0 5px 0;
      color: #2c5282;
      font-weight: 700;
    }

    .comprobante-header p {
      margin: 0;
      font-size: 0.75rem;
    }

    .comprobante-resumen {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 0 10px;
    }

    .comprobante-cliente p, 
    .comprobante-monto p {
      margin: 5px 0;
      font-size: 0.85rem;
      color: #222831;
    }

    .comprobante-cliente strong,
    .comprobante-monto strong {
      font-weight: 700;
    }

    .comprobante-firma {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding: 0 10px;
    }

    .firma-cliente {
      text-align: center;
      width: 150px;
      color: #222831;
    }

    .linea-firma {
      border-bottom: 1px solid #222831;
      margin-bottom: 1px;
      height: 20px;
    }

    .firma-cliente p {
      margin-top: 2px;
      margin-bottom: 0;
      font-size: 0.9rem;
    }

    .fecha-pago {
      font-size: 0.8rem;
      color: #222831;
      margin-top: 0px;
    }

    .info-contacto {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0px;
      margin-top: -5px;
    }

    .telefono-pago {
      font-size: 0.7rem;
      color: #222831;
      margin-bottom: 2px;
    }

    .recibo-transaccion {
      margin-bottom: 15px;
      padding: 8px;
      background-color: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 4px;
    }

    .recibo-transaccion h3 {
      background-color: #ea580c;
      color: white;
      padding: 4px 8px;
      font-size: 0.85rem;
      margin: -8px -8px 8px -8px;
      border-radius: 3px 3px 0 0;
    }

    .transaccion-detalle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }

    .transaccion-descripcion {
      flex: 1;
      margin-right: 10px;
    }

    .transaccion-monto {
      text-align: right;
      font-weight: bold;
    }

    .monto-deuda {
      color: #dc2626;
    }

    .monto-devolucion {
      color: #059669;
    }

    .monto-detalle {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .total-destacado {
      background-color: #f7fafc;
      border: 2px solid #2c5282;
      border-radius: 4px;
      padding: 8px;
      text-align: center;
      margin-top: 8px;
    }

    .total-destacado p {
      margin: 0;
      font-size: 0.9rem !important;
      font-weight: bold;
      color: #2c5282;
    }

    .nota-pago-resaltada {
      color: #2c5282;
      background: #e6f7ff;
      padding: 3px 7px;
      border-radius: 4px;
      font-weight: 700;
      font-size: 0.78rem;
      margin-bottom: 2px;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      line-height: 1.4;
    }

    .nota-corte-resaltada {
      color: #2c5282;
      background: #e6f7ff;
      padding: 3px 7px;
      border-radius: 4px;
      font-weight: 500;
      font-size: 0.92rem;
      margin-bottom: 2px;
      display: block;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nota-corte-resaltada strong {
      color: #d97706;
      background: #fffbe6;
      padding: 0 3px;
      border-radius: 2px;
      font-weight: 700;
      font-size: 1.02em;
      letter-spacing: 1px;
    }

    .recibo-deudas-lectura,
    .recibo-deudas-otros {
      margin: 15px 0;
      padding: 12px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
    }

    .recibo-deudas-lectura h3 {
      color: #dc3545;
      font-size: 0.9rem;
      margin: 0 0 10px 0;
      text-align: center;
      background-color: #f8d7da;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #f5c6cb;
    }

    .recibo-deudas-otros h3 {
      color: #fd7e14;
      font-size: 0.9rem;
      margin: 0 0 10px 0;
      text-align: center;
      background-color: #fff3cd;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ffeaa7;
    }

    .tabla-deudas {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .tabla-deudas th,
    .tabla-deudas td {
      padding: 6px 8px;
      text-align: left;
      border: 1px solid #dee2e6;
    }

    .tabla-deudas th {
      background-color: #e9ecef;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tabla-deudas td:last-child,
    .tabla-deudas th:last-child {
      text-align: right;
    }

    .tabla-deudas .total-row {
      background-color: #f8f9fa;
      border-top: 2px solid #6c757d;
    }

    .tabla-deudas .total-row td {
      font-weight: 600;
      color: #495057;
    }

    .desglose-total {
      margin-top: 8px;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .desglose-total p {
      margin: 2px 0;
      display: flex;
      justify-content: space-between;
      color: #6c757d;
    }

    .recibo-section { margin-bottom: 10px; }
    .recibo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 6px 12px; }
    .recibo-table { width: 100%; border-collapse: collapse; margin-top: 6px; }
    .recibo-table th, .recibo-table td { border: 1px solid #e5e7eb; padding: 6px; text-align: left; font-size: 14px; }
    .totales { font-weight: 700; font-size: 16px; margin-top: 8px; }

    @media print {
      .recibo-imprimible {
        width: 190mm;
        max-width: 190mm;
        height: 135mm;
        margin: 0;
        page-break-inside: avoid;
        font-size: 9pt;
        padding: 8mm;
        box-sizing: border-box;
      }
      
      body {
        background: white;
        margin: 0;
        padding: 0;
      }
      
      .recibo-header {
        padding-bottom: 8px;
        margin-bottom: 10px;
      }
      
      .recibo-cliente h3,
      .recibo-consumo h3 {
        padding: 5px 8px;
        font-size: 11pt;
        margin-bottom: 8px;
        color: #222831;
      }
      
      .tabla-consumo th, 
      .tabla-consumo td {
        padding: 5px;
        font-size: 9pt;
        color: #222831;
      }

      .recibo-principal {
        padding-bottom: 5px;
        margin-bottom: 5px;
      }
      
      .recibo-comprobante {
        border-top: 1px dashed #999;
        margin-top: 5px;
        padding-top: 5px;
      }

      .recibo-transaccion {
        margin-bottom: 8px;
        padding: 5px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
      }
      
      .recibo-transaccion h3 {
        font-size: 10pt;
        padding: 3px 6px;
        margin: -5px -5px 5px -5px;
      }
      
      .transaccion-detalle {
        font-size: 9pt;
      }

      .recibo-deudas-lectura,
      .recibo-deudas-otros {
        background-color: white !important;
        border: 1px solid #000 !important;
      }
      
      .recibo-deudas-lectura h3,
      .recibo-deudas-otros h3 {
        background-color: white !important;
        border: 1px solid #000 !important;
        color: #000 !important;
      }
      
      .tabla-deudas th {
        background-color: #f0f0f0 !important;
      }
      
      .desglose-total {
        background-color: white !important;
        border: 1px solid #000 !important;
      }
    }

    @media screen and (max-width: 600px) {
      .recibo-imprimible {
        font-size: 0.8rem;
      }
      
      .recibo-header {
        padding-bottom: 8px;
        margin-bottom: 10px;
      }
      
      .recibo-cliente-datos {
        gap: 3px 8px;
      }
      
      .tabla-consumo th, .tabla-consumo td {
        padding: 3px 5px;
      }
      
      .comprobante-resumen {
        margin-bottom: 5px;
      }
      
      .comprobante-firma {
        margin-top: 10px;
      }
      
      .linea-firma {
        height: 15px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
  <div class="layout">
    <div class="card">
      <h1>Consulta P√∫blica de Recibos</h1>
      <div class="row">
        <input id="busqueda" placeholder="Ej: A-01" />
        <button id="btnBuscar">Buscar</button>
        <button id="btnLimpiar" style="background:#6b7280;">Limpiar</button>
      </div>
      <div class="status" id="status">Cargando datos...</div>
      <div class="row" style="margin-top:8px;">
        <button id="btnDescargar" disabled>üì• Descargar PNG</button>
      </div>
    </div>

    <div class="card">
      <h2>Recibo</h2>
      <div id="recibo-container" class="recibo-wrapper muted">Sin selecci√≥n.</div>
    </div>
  </div>

  <script>
    let data = null;
    let seleccionado = null;
    let config = {};
    let modoDetalle = false; // false = resumen, true = detalle completo
    const statusEl = document.getElementById('status');
    const reciboContainer = document.getElementById('recibo-container');
    const btnDescargar = document.getElementById('btnDescargar');
    const base = location.pathname.endsWith('/') ? location.pathname : location.pathname + '/';

    const tryFetch = async (url) => {
      const r = await fetch(url);
      if (!r.ok) throw new Error('No encontrado');
      return r.json();
    };

    const redondear05 = (v) => Math.round(v * 20) / 20;

    const calcularTotal = (consumoStr, deudas) => {
      const consumo = Number.parseFloat(consumoStr || '0') || 0;
      let montoConsumo = consumo < 5 ? 5 : consumo * 1.01;
      const gastosAdmin = 1;
      let total = redondear05(montoConsumo) + redondear05(gastosAdmin);
      const extra = deudas?.totales?.general || 0;
      total += extra;
      return redondear05(total);
    };

    // VERSI√ìN 1: RESUMEN (adaptado a m√≥vil)
    const renderResumen = (recibo) => {
      const cfg = config || {};
      const periodo = cfg.periodo ? `${cfg.periodo}-${(cfg.anio || '').toString().slice(-2)}` : '-';
      const fecha = cfg.fecha || new Date().toLocaleDateString('es-PE');
      const total = calcularTotal(recibo.ultimaLectura?.consumo, recibo.deudas);
      const consumo = Number.parseFloat(recibo.ultimaLectura?.consumo || '0') || 0;

      reciboContainer.classList.remove('muted');
      reciboContainer.innerHTML = `
        <div style="padding: 20px; background: white; border-radius: 10px; border: 1px solid #e5e7eb;">
          <div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2c5282;">
            <div style="font-size: 1.2rem; font-weight: 700; color: #2c5282; margin-bottom: 5px;">
              ‚ö° RECIBO DE LUZ
            </div>
            <div style="font-size: 0.85rem; color: #4a5568;">
              Per√≠odo: ${periodo} | Fecha: ${fecha}
            </div>
          </div>

          <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="font-size: 0.95rem; margin-bottom: 8px;">
              <strong>Propietario:</strong> ${recibo.puesto?.propietario || '-'}
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
              <div><strong>Puesto:</strong> ${recibo.puesto?.numero_puesto || '-'}</div>
              <div><strong>Medidor:</strong> ${recibo.puesto?.numero_medidor || '-'}</div>
            </div>
          </div>

          <div style="background: #edf2f7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
              <div>
                <div style="color: #6b7280; font-size: 0.75rem; margin-bottom: 3px;">Lectura Anterior</div>
                <div style="font-weight: 600;">${Number.parseFloat(recibo.ultimaLectura?.lectura_anterior || 0).toFixed(2)}</div>
              </div>
              <div>
                <div style="color: #6b7280; font-size: 0.75rem; margin-bottom: 3px;">Lectura Actual</div>
                <div style="font-weight: 600;">${Number.parseFloat(recibo.ultimaLectura?.lectura_actual || 0).toFixed(2)}</div>
              </div>
              <div>
                <div style="color: #6b7280; font-size: 0.75rem; margin-bottom: 3px;">Consumo</div>
                <div style="font-weight: 600; color: #2c5282;">${consumo} kWh</div>
              </div>
              <div>
                <div style="color: #6b7280; font-size: 0.75rem; margin-bottom: 3px;">N¬∞ Recibo</div>
                <div style="font-weight: 600;">${String(recibo.ultimaLectura?.id || '').padStart(6, '0')}</div>
              </div>
            </div>
          </div>

          <div style="background: linear-gradient(135deg, #2c5282, #1e3a5f); color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.85rem; margin-bottom: 5px; opacity: 0.9;">Total a Pagar</div>
            <div style="font-size: 1.8rem; font-weight: 700;">S/. ${total.toFixed(2)}</div>
          </div>

          <button id="btnVerDetalle" style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg,#059669,#047857); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">
            üìã Ver Recibo Completo
          </button>
        </div>
      `;

      document.getElementById('btnVerDetalle').addEventListener('click', () => {
        modoDetalle = true;
        renderDetalleAdaptado(recibo);
      });
    };

    // VERSI√ìN 2: DETALLE COMPLETO ADAPTADO (adaptado a m√≥vil con max-width: 100%)
    const renderDetalleAdaptado = (recibo) => {
      const cfg = config || {};
      const periodo = cfg.periodo ? `${cfg.periodo}-${(cfg.anio || '').toString().slice(-2)}` : '-';
      const fecha = cfg.fecha || new Date().toLocaleDateString('es-PE');
      const total = calcularTotal(recibo.ultimaLectura?.consumo, recibo.deudas);

      const deudaOtros = recibo.deudas?.totales?.otros || 0;
      const deudaLect = recibo.deudas?.totales?.lectura || 0;
      
      const consumo = Number.parseFloat(recibo.ultimaLectura?.consumo || '0') || 0;
      const factor = recibo.ultimaLectura?.factor || 'M√≠nimo';
      const montoConsumo = Number.parseFloat(recibo.ultimaLectura?.monto_total || '0') || 0;
      const gastosAdmin = 1;
      const grupo = recibo.puesto?.grupo || '-';

      reciboContainer.classList.remove('muted');
      reciboContainer.innerHTML = `
        <div class="recibo-imprimible" style="max-width: 100%; padding: 16px;">
          <div class="recibo-principal">
            <div class="recibo-header">
              <div class="header-linea-1">
                <div class="empresa-titulo">
                  <span class="icono-empresa">‚ö°</span>
                  <span class="nombre-empresa">PROYECTO DE ELECTRIFICACION</span>
                </div>
                <div class="numero-recibo-principal">N¬∞ ${String(recibo.ultimaLectura?.id || '').padStart(6, '0')}</div>
              </div>
              <div class="header-linea-2">
                <div class="tipo-documento">RECIBO DE LUZ</div>
                <div class="fecha-periodo">
                  <span>Fecha: ${fecha}</span>
                  <span>Per√≠odo: ${periodo}</span>
                </div>
              </div>
            </div>

            <div class="recibo-cliente">
              <h3>DATOS DEL CLIENTE</h3>
              <div class="recibo-cliente-datos-completos">
                <div class="fila-datos">
                  <div class="campo-recibo"><strong>Propietario:</strong> ${recibo.puesto?.propietario || '-'}</div>
                  <div class="campo-recibo"><strong>DNI:</strong> ${recibo.puesto?.dni || '-'}</div>
                </div>
                <div class="fila-datos">
                  <div class="campo-recibo"><strong>Puesto:</strong> ${recibo.puesto?.numero_puesto || '-'}</div>
                  <div class="campo-recibo"><strong>Medidor:</strong> ${recibo.puesto?.numero_medidor || '-'} (G${grupo})</div>
                </div>
              </div>
            </div>

            <div class="recibo-consumo">
              <h3>DETALLE DE CONSUMO</h3>
              <table class="tabla-consumo">
                <thead>
                  <tr>
                    <th>Lectura Anterior</th>
                    <th>Lectura Actual</th>
                    <th>Consumo (kWh)</th>
                    <th>Factor</th>
                    <th>Monto</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${Number.parseFloat(recibo.ultimaLectura?.lectura_anterior || 0).toFixed(2)}</td>
                    <td>${Number.parseFloat(recibo.ultimaLectura?.lectura_actual || 0).toFixed(2)}</td>
                    <td>${consumo}</td>
                    <td>${factor}</td>
                    <td>S/. ${redondear05(montoConsumo).toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td colspan="3">Gastos administrativos</td>
                    <td>-</td>
                    <td>S/. ${gastosAdmin.toFixed(2)}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="recibo-total">
              <h3>TOTAL A PAGAR: S/. ${total.toFixed(2)}</h3>
            </div>

            <div class="recibo-nota">
              <p class="nota-pago-resaltada">
                Realice su pago los d√≠as ${cfg.diaPago1 ?? '-'} de diciembre y ${cfg.diaPago2 ?? '-'} de diciembre<br>
                de 11 am a 1 pm. (O hasta las 3 pm. en puesto 90)
              </p>
              <p class="nota-corte-resaltada">
                FECHA DE CORTE <strong>${cfg.diaCorte ?? '-'} DE DICIEMBRE</strong>.
              </p>
            </div>
          </div>

          <div class="recibo-comprobante">
            <div class="comprobante-header">
              <h3>‚ö° RECIBO DE PAGO - PROYECTO ELECTRIFICACION</h3>
              <p>Recibo N¬∞ ${String(recibo.ultimaLectura?.id || '').padStart(6, '0')} | Per√≠odo: ${periodo}</p>
            </div>

            <div class="comprobante-resumen">
              <div class="comprobante-cliente">
                <p><strong>Propietario:</strong> ${recibo.puesto?.propietario || '-'}</p>
                <p><strong>Puesto:</strong> ${recibo.puesto?.numero_puesto || '-'} (Grupo ${grupo})</p>
              </div>
              <div class="comprobante-monto">
                <p><strong>Total a pagar:</strong> S/. ${total.toFixed(2)}</p>
              </div>
            </div>

            <div class="comprobante-firma">
              <div class="firma-cliente">
                <div class="linea-firma"></div>
                <p>Firma</p>
              </div>
              <div class="info-contacto">
                <p class="fecha-pago">Fecha de pago: ___/___/______</p>
              </div>
            </div>
          </div>
        </div>
        <button id="btnVolverResumen" style="width: 100%; margin-top: 15px; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">
          ‚Üê Volver al Resumen
        </button>
      `;

      document.getElementById('btnVolverResumen').addEventListener('click', () => {
        modoDetalle = false;
        renderResumen(recibo);
      });
    };

    // VERSI√ìN 3: PARA DESCARGA (formato original 500px - NO adaptado)
    const generarReciboDescarga = (recibo) => {
      const cfg = config || {};
      const periodo = cfg.periodo ? `${cfg.periodo}-${(cfg.anio || '').toString().slice(-2)}` : '-';
      const fecha = cfg.fecha || new Date().toLocaleDateString('es-PE');
      const total = calcularTotal(recibo.ultimaLectura?.consumo, recibo.deudas);
      
      const consumo = Number.parseFloat(recibo.ultimaLectura?.consumo || '0') || 0;
      const factor = recibo.ultimaLectura?.factor || 'M√≠nimo';
      const montoConsumo = Number.parseFloat(recibo.ultimaLectura?.monto_total || '0') || 0;
      const gastosAdmin = 1;
      const grupo = recibo.puesto?.grupo || '-';

      return `
        <div class="recibo-imprimible" style="max-width: 500px; padding: 20px;">
          <div class="recibo-principal">
            <div class="recibo-header">
              <div class="header-linea-1">
                <div class="empresa-titulo">
                  <span class="icono-empresa">‚ö°</span>
                  <span class="nombre-empresa">PROYECTO DE ELECTRIFICACION</span>
                </div>
                <div class="numero-recibo-principal">N¬∞ ${String(recibo.ultimaLectura?.id || '').padStart(6, '0')}</div>
              </div>
              <div class="header-linea-2">
                <div class="tipo-documento">RECIBO DE LUZ</div>
                <div class="fecha-periodo">
                  <span>Fecha: ${fecha}</span>
                  <span>Per√≠odo: ${periodo}</span>
                </div>
              </div>
            </div>

            <div class="recibo-cliente">
              <h3>DATOS DEL CLIENTE</h3>
              <div class="recibo-cliente-datos-completos">
                <div class="fila-datos">
                  <div class="campo-recibo"><strong>Propietario:</strong> ${recibo.puesto?.propietario || '-'}</div>
                  <div class="campo-recibo"><strong>DNI:</strong> ${recibo.puesto?.dni || '-'}</div>
                </div>
                <div class="fila-datos">
                  <div class="campo-recibo"><strong>Puesto:</strong> ${recibo.puesto?.numero_puesto || '-'}</div>
                  <div class="campo-recibo"><strong>Medidor:</strong> ${recibo.puesto?.numero_medidor || '-'} (G${grupo})</div>
                </div>
              </div>
            </div>

            <div class="recibo-consumo">
              <h3>DETALLE DE CONSUMO</h3>
              <table class="tabla-consumo">
                <thead>
                  <tr>
                    <th>Lectura Anterior</th>
                    <th>Lectura Actual</th>
                    <th>Consumo (kWh)</th>
                    <th>Factor</th>
                    <th>Monto</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${Number.parseFloat(recibo.ultimaLectura?.lectura_anterior || 0).toFixed(2)}</td>
                    <td>${Number.parseFloat(recibo.ultimaLectura?.lectura_actual || 0).toFixed(2)}</td>
                    <td>${consumo}</td>
                    <td>${factor}</td>
                    <td>S/. ${redondear05(montoConsumo).toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td colspan="3">Gastos administrativos</td>
                    <td>-</td>
                    <td>S/. ${gastosAdmin.toFixed(2)}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="recibo-total">
              <h3>TOTAL A PAGAR: S/. ${total.toFixed(2)}</h3>
            </div>

            <div class="recibo-nota">
              <p class="nota-pago-resaltada">
                Realice su pago los d√≠as ${cfg.diaPago1 ?? '-'} de diciembre y ${cfg.diaPago2 ?? '-'} de diciembre<br>
                de 11 am a 1 pm. (O hasta las 3 pm. en puesto 90)
              </p>
              <p class="nota-corte-resaltada">
                FECHA DE CORTE <strong>${cfg.diaCorte ?? '-'} DE DICIEMBRE</strong>.
              </p>
            </div>
          </div>

          <div class="recibo-comprobante">
            <div class="comprobante-header">
              <h3>‚ö° RECIBO DE PAGO - PROYECTO ELECTRIFICACION</h3>
              <p>Recibo N¬∞ ${String(recibo.ultimaLectura?.id || '').padStart(6, '0')} | Per√≠odo: ${periodo}</p>
            </div>

            <div class="comprobante-resumen">
              <div class="comprobante-cliente">
                <p><strong>Propietario:</strong> ${recibo.puesto?.propietario || '-'}</p>
                <p><strong>Puesto:</strong> ${recibo.puesto?.numero_puesto || '-'} (Grupo ${grupo})</p>
              </div>
              <div class="comprobante-monto">
                <p><strong>Total a pagar:</strong> S/. ${total.toFixed(2)}</p>
              </div>
            </div>

            <div class="comprobante-firma">
              <div class="firma-cliente">
                <div class="linea-firma"></div>
                <p>Firma</p>
              </div>
              <div class="info-contacto">
                <p class="fecha-pago">Fecha de pago: ___/___/______</p>
              </div>
            </div>
          </div>
        </div>
      `;
    };

    // Funci√≥n principal que decide qu√© versi√≥n mostrar
    const renderRecibo = (recibo) => {
      if (modoDetalle) {
        renderDetalleAdaptado(recibo);
      } else {
        renderResumen(recibo);
      }
      
      seleccionado = recibo;
      btnDescargar.disabled = false;
    };

    const limpiar = () => {
      seleccionado = null;
      modoDetalle = false;
      btnDescargar.disabled = true;
      reciboContainer.classList.add('muted');
      reciboContainer.textContent = 'Sin selecci√≥n.';
    };

    const buscar = () => {
      const input = document.getElementById('busqueda');
      const q = (input.value || '').trim().toLowerCase();
      if (!data) { statusEl.textContent = 'Datos no cargados.'; return; }
      if (!q) { statusEl.textContent = 'Ingresa un n√∫mero de puesto.'; limpiar(); return; }

      const hallado = (data.recibos || []).find(r => (r.puesto?.numero_puesto || '').toLowerCase() === q);
      if (!hallado) {
        statusEl.textContent = 'No se encontr√≥ el puesto.';
        limpiar();
        return;
      }
      statusEl.textContent = 'Recibo encontrado.';
      renderRecibo(hallado);
    };

    const descargarPNG = async () => {
      if (!seleccionado) return;
      
      // Crear elemento temporal oculto con formato original (500px)
      const tempContainer = document.createElement('div');
      tempContainer.style.position = 'absolute';
      tempContainer.style.left = '-9999px';
      tempContainer.style.top = '0';
      tempContainer.innerHTML = generarReciboDescarga(seleccionado);
      
      document.body.appendChild(tempContainer);
      await new Promise(resolve => setTimeout(resolve, 100));
      
      const nodo = tempContainer.querySelector('.recibo-imprimible');
      if (!nodo) return;
      
      const canvas = await html2canvas(nodo, { scale: 2, backgroundColor: '#ffffff' });
      const padding = Math.round(56.7);
      const padded = document.createElement('canvas');
      padded.width = canvas.width + padding * 2;
      padded.height = canvas.height + padding * 2;
      const ctx = padded.getContext('2d');
      if (!ctx) return;
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,padded.width,padded.height);
      ctx.drawImage(canvas, padding, padding);
      const link = document.createElement('a');
      const nombre = (seleccionado.puesto?.numero_puesto || 'recibo').replaceAll(/\s+/g, '_');
      link.href = padded.toDataURL('image/png');
      link.download = `recibo_${nombre}.png`;
      link.click();
      
      // Eliminar el elemento temporal
      document.body.removeChild(tempContainer);
    };

    document.getElementById('btnBuscar').addEventListener('click', buscar);
    document.getElementById('btnLimpiar').addEventListener('click', () => { document.getElementById('busqueda').value=''; limpiar(); statusEl.textContent='Listo.'; });
    btnDescargar.addEventListener('click', descargarPNG);

    const cargarDatos = async () => {
      try {
        data = await tryFetch(base + 'recibos.json');
        config = data.configuracion || {};
        statusEl.textContent = 'Datos cargados. Busca un puesto.';
      } catch (errorPrincipal) {
        console.warn('Fallo recibos.json', errorPrincipal);
        try {
          data = await tryFetch(base + 'recibos-demo.json');
          config = data.configuracion || {};
          statusEl.textContent = 'Usando datos de demostraci√≥n. Busca un puesto.';
        } catch (errorDemo) {
          console.error('Fallo demo', errorDemo);
          statusEl.textContent = 'No se pudieron cargar datos.';
        }
      }
    };

    cargarDatos();
  </script>
</body>
</html>
